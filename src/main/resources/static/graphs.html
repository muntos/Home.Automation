<html>
<head>
    <title>Home Automation - Charts</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.7.3/Chart.min.js"></script>
</head>

<body>
<div>
    <button id="day" class="button">
    Day
    </button>
    <button id="week" class="button">
        Week
    </button>
    <button id="month" class="button">
        Month
    </button>
    <button id="year" class="button">
        Year
    </button>
</div>
<div style="width:80%">
    <canvas id="LivingBalconyChart" height="500" width="1000"></canvas>
</div>

<script>

    var ctx = document.getElementById('LivingBalconyChart').getContext('2d');

    var aLabels = [];
    var aDatasetTemp = [];
    var aDatasetTempOutside = [];
    var aDatasetHumidity = [];
    var myChart;

    var dataT = {
        labels: aLabels,
        datasets: [{
            label: "Balcony temperature",
            data: aDatasetTemp,
            backgroundColor: "rgba(54, 162, 235, 0.2)",
            borderColor: "rgb(54, 162, 235)",
            borderWidth: 1
        },
        {
            label: "Humidity",
            data: aDatasetHumidity,
            //backgroundColor: "rgba(54, 62, 235, 0.2)",
            fill: false,
            borderColor: "rgb(54, 62, 235)",
            borderWidth: 1
        },
        {
            label: "Outside temperature",
            data: aDatasetTempOutside,
            backgroundColor: "rgba(255, 0, 0, 0.2)",
            borderColor: "rgb(255, 0, 0)",
            borderWidth: 1
        }]
    };

    var opt = {
        responsive: true,
        title: { display: true, text: 'Living Balcony' },
        legend: { position: 'bottom' }
    };


    $.when(getReadings('balcony', 'temp', 'today'),
        getReadings('balcony', 'humidity', 'today'),
        getReadings('outside', 'temp', 'today')
    ).done(function (b_t_args, b_h_args, o_t_args) {

        $.each(b_t_args[0], function(index, reading){
            aLabels.push(reading.date);
            aDatasetTemp.push(reading.value);
        });

        $.each(b_h_args[0], function(index, reading){
            aDatasetHumidity.push(reading.value);
        });

        $.each(o_t_args[0], function(index, reading){
            aDatasetTempOutside.push(reading.value);
        });

        myChart = new Chart(ctx, {
            type: 'line',
            data: dataT,
            options: opt
        });

    });


    $("#day").click(function(){
        updateChartForBalcony('day');
    });

    $("#week").click(function(){
        updateChartForBalcony('week');
    });

    $("#month").click(function(){
        updateChartForBalcony('month');
    });

    $("#year").click(function(){
        updateChartForBalcony('year');
    });

    function getReadings(location, sensor, period){
        var url = '/home/reading/' + location + '/' + sensor + '?period=' + period;
        return $.getJSON(url);
    }

    function updateChartForBalcony(period){
        aLabels = [];
        aDatasetTemp = [];
        aDatasetHumidity = [];
        aDatasetHumidity = [];

        $.when(getReadings('balcony', 'temp', period),
            getReadings('balcony', 'humidity', period),
            getReadings('outside', 'temp', period)
        ).done(function (b_t_args, b_h_args, o_t_args) {

            $.each(b_t_args[0], function(index, reading){
                aLabels.push(reading.date);
                aDatasetTemp.push(reading.value);
            });

            $.each(b_h_args[0], function(index, reading){
                aDatasetHumidity.push(reading.value);
            });

            $.each(o_t_args[0], function(index, reading){
                aDatasetTempOutside.push(reading.value);
            });

            myChart.data.labels = aLabels;
            myChart.data.datasets[0].data = aDatasetTemp;
            myChart.data.datasets[1].data = aDatasetHumidity;
            myChart.data.datasets[2].data = aDatasetTempOutside;
            myChart.update();

        });

    }

</script>

</body>
</html>
